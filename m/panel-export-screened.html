<div id=D__ID>
    <div>
        <div id=toolbar__ID class="navbar navbar-default">
        	<form class="form-inline">
        		<button type=button id=count__ID class='btn btn-secondary'>Export All</button> <a class="small font-italic text-muted mt-1"><br>Exports all data based on the setup below into a combind cvs file</a>
        	</form>
        	<span id=elapsed__ID style='float:right'></span>
		</div>
        <section id=panel__ID>
			<h3>Screened</h3>
			<span>Select the fields to export by clicking on each form links.</span><br>
        	<div class='nav__ID'>
        		<ul>
					<li title="Manage participant - Add new. Data entry for single participant. Setup questionnaires."><a href=?/participant-data>Participants</a></li>
					<p id=participant-data__ID class="small font-italic text-muted mt-1">Latest entry shown</p>
				</ul>
        	VmInclude:__CURRENT_PATH__/panel-tasks-export-screened.html
        </section>
	</div>
	VmInclude:__COMPONENT__/m/model.01.html
    <script>
        function F__ID(){
			//--------------------------------------------------------
			var export_list=[];
			var all_data=[];
			var NN=0
			var bi_txt=[];
			//--------------------------------------------------------
			$vm.module_list["__MODULE__"].show=function(){
                document.title="Export Setup | "+$vm.default_title;
				$("meta[name='description']").attr("content","Export Setup");
				//console.log($vm.module_list['export-form-spardac'].Table)
				var table=$vm.module_list['export-form-spardac'].Table;
				$vm.request({cmd:'find',table:table},function(res){
					if(res.status=='np'){
						$vm.alert("No access permissions")
					}
					if(res.result.length>0){
						export_list=res.result;
						$('#panel__ID a').each(function(){
			                var href=$(this).attr('href');
							if(href!=undefined){
								href=href.replace('?\/','');
								href=href.replace(/\//g,'_');

								$('#'+href+'__ID').html('No setup found. Will export all fields')
								var tbname=$vm.module_list[href].Table;
								for (var i=0;i<export_list.length;i++){
									if(export_list[i].Data.Table_name==tbname){
										var show=export_list[i].Data.Export_Fields;
										if(export_list[i].Data.Export_Fields=='') show='&nbsp;' ;
										$('#'+href+'__ID').html(show)
										break;										
									}
								}
							}
						})
					}		
				});
			}
			//--------------------------------------------------------
            $('#panel__ID a').on('click',function(e){
				e.preventDefault();
				var name=$(this).html()
                var href=$(this).attr('href');
                var app=$(this).attr('app');
                if(href!=undefined){
                    href=href.replace('?\/','');
					href=href.replace(/\//g,'_');
					$vm.load_module('export-form-spardac','',{name:name,link:href,goback:1})
                    //if(app==undefined) $vm.load_module(href,'',{});
                    //else if($vm.module_list[href]!=undefined) window.open($vm.module_list[href].url);
                    //else alert("The '"+ href +"' is not defined in the module list");
                }
            })
            //--------------------------------------------------------			
        	var clear_counting=function(){
        		$('.nav__ID a').each(function(){
        			var txt=$(this).attr('data-a_text');
        			if(txt!=undefined){
        				$(this).text(txt);
        			}
        		})
        	}
			//--------------------------------------------------------
            //--------------------------------------------------------
        	var set_a_text=function(){
        	    $('.nav__ID a').each(function(){
        	        $(this).attr('data-a_text',$(this).text());
        	    })
        	}
        	set_a_text();
        	//---------------------------------------------
        	$('#count__ID').on('click',function(){
				all_data=[];
				NN=0;
				bi_txt=[];
        		clear_counting();
				var N=0;
        		$('#panel__ID a').each(function(){
        			var $a=$(this);
					N++;
        			var href=$a.attr('href');
        			if(href!=undefined){
						check_count($a,N);
						var href=$a.attr('href');
						href=href.replace('?\/','');
						if($vm.module_list[href]!=undefined){
	        				var tb_txt=$vm.module_list[href];
							bi_txt.push(tb_txt);
						}
        			}
				});
				//console.log(bi_txt)
        	})
        	//--------------------------------------------------------
        	var check_count=function($a,N){
        		//do not send too many requests to the server in a short period
        		setTimeout(function(){check_count_d($a)}, N*1000);
        	}
			//--------------------------------------------------------
        	var check_count_d=function($a){
        		var href=$a.attr('href');
				href=href.replace('?\/','');
        		if($vm.module_list[href]!=undefined){
        			var tb=$vm.module_list[href].Table;
        			if(tb!=undefined){
						var req={cmd:"export",table:tb,query:""}
						open_model__ID();
						$vm.request(req,function(N,i,txt){
							//console.log(i+"/"+N);
							$('#msg__ID').text((100*i/N).toFixed(0)+"%");
							if(i==-1){
								NN++;
								var len=txt.length;
								var n_txt="["+txt.substring(5,len-9)+"]";
								var o=JSON.parse(n_txt);
								console.log("NN:"+NN +" "+bi_txt.length);
								//console.log(JSON.stringify(o));
								all_data.push(o)
								//$vm.download_csv(tb+".csv",o);
								close_model__ID();
								var txt=$a.attr('data-a_text');
								txt=$('<div/>').html(txt).text();
								var num=$('<div/>').html('Done').text();
								$a.html(txt+" <mark class=count_marker__ID>["+num+"]</mark>")
								if(NN==bi_txt.length){
									prepare_output(all_data);
								}
							}
						});
					}
				}
			}
			//--------------------------------------------------------
        	var prepare_output=function(data){
				//Get participant's labels. 
				var total_output=[];
				var total_participant=[];
				var participant_rec = data[0];
				var participant_labels=[];
				//try to see if participant_export is defined in Module list
				for (var i=0;i<export_list.length;i++){
					//console.log(export_list[i].Data.Table_name+' - '+bi_txt[j].Table)
					if(export_list[i].Data.Table_name==bi_txt[0].Table){
						//Labels from setup
						var show=export_list[i].Data.Export_Fields;
						show="ID,"+show;
						participant_labels=show.split(',');
						break;										
					}
					else if(i==export_list.length-1){
						//Extract labels from last record entered.
						for (var k in data[0][data[0].length-1]){
							if(k!=="_Password" && k!=="List") participant_labels.push(k);
						}
					}
				}
				//console.log("participant: "+JSON.stringify(participant_labels));
				//Get entry Form labels (record field's name). Take last entered record. 
				for(var j=1;j<bi_txt.length;j++){
					var export_labels=[];
					for (var i=0;i<export_list.length;i++){
						//console.log(export_list[i].Data.Table_name+' - '+bi_txt[j].Table)
						if(export_list[i].Data.Table_name==bi_txt[j].Table){
							//Labels from Setup
							var show=export_list[i].Data.Export_Fields;
							export_labels=show.split(',');
							break;										
						}
						if(i==export_list.length-1){
						//Extract labels from last record entered.
						for (var k in data[j][data[j].length-1]){
								if(k!=="ID" && k!=="_status" && k!=="sysStatus" && k!='Participant') export_labels.push(k)
							}
						}
					}
					//create an empty record with all labels that will be filled in
					var empty_participant={} 
					var empty_item={}
					//console.log(participant_labels.length)
					for(var i=0;i<participant_labels.length;i++){
						empty_participant[participant_labels[i]]="";
					}
					//console.log("exp: "+JSON.stringify(empty_participant))
					for(var i=0;i<export_labels.length;i++){
						empty_item[export_labels[i]]="";
					}
					//console.log("ex: "+JSON.stringify(empty_item))
					var empty_item2={};
					var empty_participant2={};
					//Loop through all participants and fill in record fields (labels) linked to them.
					//Put all in output_data object
					var output_data=[];
					var participant_data=[];
					for(var ii=0;ii<participant_rec.length;ii++){
						empty_item2={};
						empty_participant2={};
						task_rec=data[j];
						for (var kk=0;kk<task_rec.length;kk++){
							if(task_rec[kk].Participant_uid==participant_rec[ii].ID){
								//Get a new empty object
								empty_item2=(JSON.parse(JSON.stringify(empty_item)));
								empty_participant2=(JSON.parse(JSON.stringify(empty_participant)));
								//Fill participants details
								for( var ll=0;ll<participant_labels.length;ll++){
									if(participant_rec[ii].hasOwnProperty(participant_labels[ll])){
										empty_participant2[participant_labels[ll]]=participant_rec[ii][participant_labels[ll]];
									}
								}
								//Fill records from tasks
								for( var ll=0;ll<export_labels.length;ll++){
									if(task_rec[kk].hasOwnProperty(export_labels[ll])){
										empty_item2[export_labels[ll]]=task_rec[kk][export_labels[ll]];
									}
								}
								//console.log("item: "+JSON.stringify(empty_item2))
								//console.log("part: "+JSON.stringify(empty_participant2))
								output_data.push(empty_item2);
								participant_data.push(empty_participant2)
								break;
							}
							//Can't find record for this participant
							else if(kk==task_rec.length-1){
								empty_item2=(JSON.parse(JSON.stringify(empty_item)));
								for( var ll=0;ll<participant_labels.length;ll++){
									if(participant_rec[ii].hasOwnProperty(participant_labels[ll])){
										empty_participant2[participant_labels[ll]]=participant_rec[ii][participant_labels[ll]];										
									}
								}
								output_data.push(empty_item2)
								participant_data.push(empty_participant2)
							}
						}
					}

					var tmp=JSON.stringify(output_data).replace(/"off"/g,'"N"').replace(/"on"/g,'"Y"') //.replace(',"":""','');
					output_data=JSON.parse(tmp);
					//Add a number "X_" for all labels apart from particpant and first records, so we don't have duplicated lables
					if(j>0){
						for (var i in output_data){
							for (var o in output_data[i]){
								var o_val=output_data[i][o];
								delete output_data[i][o];
								o=j.toString()+'_'+o;
								output_data[i][o]=o_val
							}  
						}
					}
					//console.log("out: "+JSON.stringify(output_data));
					//console.log("part: "+JSON.stringify(participant_data));
					total_output.push(output_data)
					total_participant.push(participant_data)
				}
				//console.log(JSON.stringify(total_output));
				//console.log(JSON.stringify(participant_data));
				combine_output(total_output,total_participant)
			}
			//--------------------------------------------------------
			var combine_output=function(output,participant){
				var single="";
				var all="";
				var final=[];
				//Combine all reords for each participant
				for(var j=0;j<participant[0].length;j++){
					all=JSON.stringify(participant[0][j]);
					for(var i=0;i<output.length;i++){
						single=JSON.stringify(output[i][j])
						all+=single;
					}
					all=all.replace(/}{/g,',')
					final.push(JSON.parse(all))
				}
				//console.log(JSON.stringify(final));
				$vm.download_csv("Spardac Screened Export.csv",final);
			}		
		}
    </script>
    <style>
        #toolbar__ID{
			font-family: 'Roboto Slab';
    		background-color:#ccc;
    		margin-bottom:0px;
    		overflow:hidden;
            padding: 5px 0 5px 10px;
    	}
        #toolbar__ID .form-inline > * {
            margin-right:5px;
        }
    	@media screen and (max-width:768px){
    		#toolbar__ID{
    			padding: 3px 10px;
    		}
    		#toolbar__ID div{
    			padding-left:3px;
    		}
    	}
        #D__ID{
    		background-color:#fff;
    		height:100%;
    		overflow: auto;
    		animation: vm_module_fadein 1.0s;
    	}
        #panel__ID{
            font-family: 'Roboto Slab';
    		padding:20px 0 0 20px;
    	}
    	#panel__ID a {
    		text-decoration: none;
    	}
    	#panel__ID a:link {
    		color:#555;
    	}
    	#panel__ID a:visited {
    		color:#555;
    	}
    	#panel__ID a:hover {
    		color:red;
    	}
    	#panel__ID a:active {
    		color:#555;
    	}
        .nav__ID{
	        padding:6px 26px 6px 6px;
	        float:left;
	    }
	    .nav__ID span{
			color:#283f55;
			font-weight: bold;
			margin:3px 10px;
	    }
		.count_marker__ID{
			background-color:#fff;
			font-size:12px;
		}
    	@media screen and (max-width:768px){
    		#panel__ID{
    			padding:10px 0 0 10px;
    		}
    	}
    </style>
</div>
